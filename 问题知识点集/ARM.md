# ARM

## 相关概念

### 基础知识

1. 机器码：机器码是机器能够识别和执行的 0 和 1 的序列，是机器指令的二进制表示形式。
2. 汇编指令：汇编指令可以被汇编器转换成机器码，是机器码的助记符。
3. 汇编指令集：汇编指令的集合，是机器指令的集合。
4. ARM 架构：ARM 架构是指 ARM 公司的一系列**处理器架构**，是一种 RISC(精简指令集) 架构。**处理器架构是指处理器的硬件设计，包括指令集、寄存器、中断、总线等。**
5. ARM 内核：ARM 基于不同的处理器架构(ARM 架构)设计了不同的处理器内核，比如 ARMv7 内核、ARMv8 内核等。
6. ARM 处理器：ARM 处理器是指集成了 ARM 内核的处理器，比如 ARM Cortex-A53 处理器、ARM Cortex-A72 处理器等。
7. SOC(System On Chip，系统级芯片)：SOC 是指集成了处理器、内存、外设等功能的芯片，比如 RK3288 芯片、RK3399 芯片等。
8. ARM 芯片：ARM 芯片是指集成了 ARM 处理器的 **SOC**，比如 RK3288 芯片、RK3399 芯片，也可以指集成了 ARM 处理器的单片机，比如 STM32F103 芯片。

### RISC 和 CISC

RISC(精简指令集) 和 CISC(复杂指令集) 是两种不同的处理器架构。

1. RISC(Reduced Instruction Set Computer)：指令集中的指令数量少，**指令长度固定**(一般为 32 位, **4 字节**, 8 个十六进制数)，指令执行时间短，每条指令只能完成简单的操作，但是可以通过组合指令来完成复杂的操作。
2. CISC(Complex Instruction Set Computer)：指令集中的指令数量多，**指令长度不固定**，指令执行时间长，每条指令可以完成复杂的操作。

### ARM 和 x86

ARM 和 x86 是两种不同的处理器架构。

1. ARM：ARM 是一种 RISC(精简指令集) 架构，指令集中的指令数量少，指令长度固定，指令执行时间短，每条指令只能完成简单的操作，但是可以通过组合指令来完成复杂的操作。
2. x86：x86 是一种 CISC(复杂指令集) 架构，指令集中的指令数量多，指令长度不固定，指令执行时间长，每条指令可以完成复杂的操作。

## ARM 处理器工作模式

### Cortex-M4 处理器工作模式

Cortex-M4 处理器有两种工作模式：线程模式和异常模式。

1. 线程模式：线程模式是 Cortex-M4 处理器的默认工作模式，线程模式下的处理器可以执行所有的指令，可以访问所有的寄存器，可以访问所有的外设，可以访问所有的内存。运行用户主程序代码。
2. 异常模式：运行异常处理程序代码。比如，当发生中断时，处理器会从线程模式切换到异常模式，执行中断处理程序代码。

### Cortex-A7 处理器工作模式

Cortex-A7 处理器有九种工作模式：用户模式(User Mode)、系统模式(System Mode)、快速中断模式(Fast Interrupt Mode)、普通中端模式(Interrupt Request Mode)、超级管理模式(SVC(SuperVisor Call) Mode)、中止模式(Abort Mode)、未定义模式(Undefined Mode)、监控模式(Monitor Mode)、虚拟化技术支持(PHY Mode)。

分多种模式的原因是为了提高处理器的执行效率，**每种模式下处理器可以执行的指令和访问的寄存器、外设、内存都不同。**

## **ARM 寄存器**

### ARM 寄存器分类

ARM 寄存器分为通用寄存器、特殊寄存器、系统寄存器、浮点寄存器、NEON 寄存器。

### ARM 寄存器的作用

### ARM 寄存器的命名规则

### R0-R12 通用寄存器

R0-R12 通用寄存器是 ARM 处理器中的一种通用寄存器，用于存储数据。

### R13-R15 寄存器 特殊功能寄存器(Special Function Registers, SFR)

R13-R15 寄存器是 ARM 处理器中的一种特殊寄存器，用于存储数据和控制处理器的工作模式。

1. R13 寄存器：堆栈指针寄存器(Stack Pointer, SP)。用于存储堆栈的地址。
2. R14 寄存器：链接寄存器(Link Register, LR)。用于存储函数的返回地址。
3. R15 寄存器：程序计数器(Program Counter, PC)。用于存储下一条指令的地址。

### CPSR(Current Program Status Register) 寄存器

CPSR 寄存器是 ARM 处理器中的一种特殊寄存器，用于存储处理器的状态信息。

作用：用于存储处理器的状态信息，比如处理器的工作模式、条件标志位等。

高 4 位：条件标志位

1. N[31]：负数标志位(Negative)。当运算结果为负数时，N 置 1，否则置 0。
2. Z[30]：零标志位(Zero)。当运算结果为 0 时，Z 置 1，否则置 0。
3. C[29]：进位标志位(Carry)。
   - 加法：当运算结果超出 32 位时，进位(上溢)，C 置 1，否则置 0。
   - 减法：当运算结果小于 0 时，借位(下溢)，C 置 0，否则置 1。
4. V[28]：溢出标志位(Overflow)。符号位发生改变，V 置 1，否则置 0。

中间 5 位：保留位

低 19 位：控制位

1. I[7]：中断屏蔽位(Interrupt Mask)。当 I 置 1 时，屏蔽所有中断，当 I 置 0 时，允许所有中断。
2. F[6]：快速中断屏蔽位(Fast Interrupt Mask)。当 F 置 1 时，屏蔽快速中断，当 F 置 0 时，允许快速中断。
3. T[5]：Thumb 模式位。当 T 置 1 时，处理器处于 Thumb 模式，当 T 置 0 时，处理器处于 ARM 模式。
4. M[4:0]：处理器模式位。用于存储处理器的工作模式。
   | M[4:0] | 模式 | 说明 |
   | :---: | :---: | :---: |
   | 10000 | 用户模式(User) | 用于运行用户程序 |
   | 10001 | 快速中断模式(FIQ) | 用于处理快速中断 |
   | 10010 | 中断请求模式(IRQ) | 用于处理中断请求 |
   | 10011 | 超级管理模式(SVC) | 用于处理软件中断 |
   | 10110 | 监控模式(Monitor) | 用于处理调试 |
   | 10111 | 中止模式(Abort) | 用于处理数据访问异常 |
   | 11011 | 未定义模式(Undefined) | 用于处理未定义指令 |
   | 11111 | 系统模式(System) | 用于处理系统级别的软件 |

   其他没有使用的则保留
5. Q[27]：饱和标志位(Saturation)。当运算结果超出 32 位时，称为上溢，Q 置 1，否则置 0。
   ....

### SPSR(Saved Program Status Register) 寄存器

SPSR 寄存器是 ARM 处理器中的一种特殊寄存器，用于存储处理器的状态信息。

作用：保存 CPSR 寄存器的值。

## 指令流水线

指令流水线的作用：提高处理器的执行效率。

指令流水线的原理：将指令的执行过程分为多个步骤，每个步骤由一个硬件电路来完成，这样就可以同时执行多条指令。

### 三级流水线

ARM 处理器的指令流水线分为三级流水线：取指令、译码、执行。

1. 取指令：从内存中读取指令。
2. 译码：将指令翻译成处理器可以执行的指令。
3. 执行：执行指令。
