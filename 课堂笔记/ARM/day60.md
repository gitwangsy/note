# day60

为什么需要混合编程？

汇编语言可以直接访问硬件，C 语言不能直接访问硬件。

## ATPCS 规则

ATPCS：ARM Thumb Procedure Call Standard，即 ARM Thumb 函数调用规则。

ATPCS 规则是 ARM 嵌入式系统中的一种函数调用规则，它定义了函数调用时，参数传递、返回值传递、寄存器的使用等规则。

### 寄存器的使用

ATPCS 规则中定义了一些寄存器的使用规则，这些寄存器被称为**保留寄存器**。

保留寄存器分为两类：

1. 用于函数调用时，保存临时数据的寄存器，包括 r0、r1、r2、r3、r12。
2. 用于函数调用时，保存重要数据的寄存器，包括 r4、r5、r6、r7、r8、r9、r10、r11。
3. 用于函数调用时，保存返回地址的寄存器，包括 lr。
4. 用于函数调用时，保存栈指针的寄存器，包括 sp。
5. 用于函数调用时，保存状态寄存器的寄存器，包括 cpsr。

### 参数传递

1. 参数传递的顺序是从右到左。
2. 参数传递的个数不能超过 4 个。
3. 参数传递的类型只能是整型或指针类型。

### 返回值传递

1. 返回值传递的类型只能是整型或指针类型。

### 函数调用

## 混合编程

### 汇编调用 C 语言函数

1. 在汇编文件中声明 C 语言函数。

   ```assembly
   // .extern 表示声明一个外部函数
   .extern func
   ```

2. 在 C 语言文件中实现 C 语言函数。

   ```c
   // 函数声明
   void func(void)
   {
      // 函数体
   }
   ```

3. 在汇编文件中调用 C 语言函数。

   ```assembly
   // 调用函数
   bl func
   ```

### C 语言调用汇编函数

1. 在 C 语言中声明汇编函数。

   ```c
   // extern 表示声明一个外部函数
   extern void func(void);
   ```

2. 在汇编文件中实现汇编函数。

   ```assembly
   // .global 表示声明一个全局函数
   .global func
   func:
   // 函数体
   ```

3. 在 C 语言中调用汇编函数。

   ```c
   // 调用函数
   func();
   ```

### 内联汇编

语法：

```c
__asm__ __volatile__ (
assembler template
: output operands                  // 输出操作数
: input operands                   // 输入操作数
: list of clobbered registers      // 破坏寄存器列表
);
```

示例：

```c
int add(int a, int b)
{
  int c;
  __asm__ __volatile__ (
    "add %0, %1, %2\n"          // %0 表示输出操作数，%1 和 %2 表示输入操作数
    : "=r"(c)                    // 输出操作数
    : "r"(a), "r"(b)             // 输入操作数
    : "cc"                       // 破坏寄存器列表
  );
  return c;
}
```

## ARM 开发板

### 开发板介绍

开发板是一种嵌入式系统，它是由处理器、存储器、外设等组成的一种计算机系统。

### 开发板的组成

1. 处理器：ARM 处理器。
2. 存储器：RAM、ROM、Flash、SDRAM、NOR Flash、NAND Flash。
3. 外设：串口、并口、USB、网口、LCD、摄像头、触摸屏、按键、LED 灯、蜂鸣器、电源管理、RTC、ADC、DAC、DMA、PWM、I2C、SPI、SDIO、CAN、GPIO 等。
4. 其他：电源、按键、LED 灯、蜂鸣器、LCD、摄像头、触摸屏、网口、USB、串口、并口、SD 卡、JTAG 等。

### 相关硬件术语

1. 芯片(Chip)：芯片是一种集成电路，它是由晶体管、电阻、电容等元器件组成的一种电路。
2. 原理图(Schematic)：原理图是一种电路图，它是由芯片、电阻、电容、晶体管等元器件组成的一种电路图。
   - VCC_3V3：3.3V 电源 (正)
   - GND：地 (负)
   - LED：LED 灯
   - MMBT：三极管
3. 印制电路板(PCB(Printed Circuit Board))：PCB 板设计工程师根据原理图设计出来的电路板。
4. 丝印(Silkscreen)：丝印是印制电路板上的文字或图形(白色)，它是用来标识元器件的位置、方向、型号等信息的。
   - U?：芯片
   - R?：电阻
   - C?：电容
   - L?：电感
   - D?：二极管
   - LD?：LED 灯
   - Q?：三级管
   - J?：接口
   - X?：晶振
   - CON?：连接器
5. 元器件：电阻、电容、晶体管、二极管、晶振、连接器等。
6. 网络标号/编号/标签：原理图中红色的字，网络标号相同的两个引脚具有相同的电气连接关系。
7. SOC: System On Chip，即系统级芯片，它是一种集成电路，它是由处理器、存储器、外设等组成的一种计算机系统。

### 电路图
